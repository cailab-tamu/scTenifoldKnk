require(pbapply)
require(ggplot2)
overlapR <- pbsapply(seq_len(B), function(Z){
nRanks <- min(c(length(gList1), length(gList2)))
rList1 <- sample(gList1)
rList2 <- sample(gList2)
rOverlap <- sapply(seq_len(nRanks), function(X){
length(intersect(rList1[seq_len(X)], rList2[seq_len(X)]))
})
return(rOverlap)
})
nRanks <- min(c(length(gList1), length(gList2)))
rOverlap <- sapply(seq_len(nRanks), function(X){
length(intersect(gList1[seq_len(X)], gList2[seq_len(X)]))
})
listComparison <- data.frame(
rank = seq_len(nRanks),
real = rOverlap,
expLB = apply(overlapR,1,mean) - 5* apply(overlapR,1,sd),
exp = apply(overlapR,1,mean),
expUB = apply(overlapR,1,mean) + 5* apply(overlapR,1,sd)
)
ggplot(data = listComparison, mapping = aes(x = rank, y = real)) +
geom_line(mapping = aes(colour= label)) +
geom_ribbon(mapping = aes(ymin=expLB, ymax=expUB), alpha=0.3, fill = "#E69F00") +
geom_line(mapping = aes(x = rank, y = exp, colour='Expected by\nrandom')) +
geom_abline(intercept = 0, slope = 1, lty = 2) +
theme_bw() + xlab('Rank') + ylab('Size of Overlap') + ylim(c(0,7776)) + xlim(c(0,7776)) +
scale_fill_manual(name="Overlap:",aesthetics = 'colour', values=c("#E69F00","#999999")) +
theme(legend.position="top")
}
compareList <- function(gList1, gList2, B = 100, label = 'L'){
require(pbapply)
require(ggplot2)
overlapR <- pbsapply(seq_len(B), function(Z){
nRanks <- min(c(length(gList1), length(gList2)))
rList1 <- sample(gList1)
rList2 <- sample(gList2)
rOverlap <- sapply(seq_len(nRanks), function(X){
length(intersect(rList1[seq_len(X)], rList2[seq_len(X)]))
})
return(rOverlap)
})
nRanks <- min(c(length(gList1), length(gList2)))
rOverlap <- sapply(seq_len(nRanks), function(X){
length(intersect(gList1[seq_len(X)], gList2[seq_len(X)]))
})
listComparison <- data.frame(
rank = seq_len(nRanks),
real = rOverlap,
expLB = apply(overlapR,1,mean) - 5* apply(overlapR,1,sd),
exp = apply(overlapR,1,mean),
expUB = apply(overlapR,1,mean) + 5* apply(overlapR,1,sd)
)
ggplot(data = listComparison, mapping = aes(x = rank, y = real)) +
geom_line(mapping = aes(colour= label)) +
geom_ribbon(mapping = aes(ymin=expLB, ymax=expUB), alpha=0.3, fill = "#E69F00") +
geom_line(mapping = aes(x = rank, y = exp, colour='Expected by\nrandom')) +
geom_abline(intercept = 0, slope = 1, lty = 2) +
theme_bw() + xlab('Rank') + ylab('Size of Overlap') + ylim(c(0,7776)) + xlim(c(0,7776)) +
scale_fill_manual(name="Overlap:",aesthetics = 'colour', values=c("#E69F00","#999999")) +
theme(legend.position="top")
}
CLB <- compareList(realList,drList,B = 2, label = 'scTenifoldNet vs scTenifoldKnk')
CLB
CLB <- compareList(realList,drList,B = 2, label = 'scTenifoldNet vs\nscTenifoldKnk')
CLB
CLB <- compareList(realList,drList,B = 100, label = 'scTenifoldNet vs\nscTenifoldKnk')
CLB
png('cl2_Ahr.png', width = 1000, height = 1000, res = 300)
CLB
dev.off()
png('cl2_Ahr.png', width = 1200, height = 1200, res = 300)
CLB
dev.off()
CLA <- compareList(deList,drList,B = 100, label = 'MAST (abs FC) vs\nscTenifoldKnk')
CLA
png('cl1_Ahr.png', width = 1200, height = 1200, res = 300)
CLA
dev.off()
setwd("~/scTenifoldKnk/inst/manuscript/AHR/Code")
load('../Results/Preenterocytes.RData')
MA <- O$manifoldAlignment
MA <- MA[!grepl('_MT-|_RPL|_RPS',rownames(MA), ignore.case = TRUE),]
DR <- scTenifoldNet::dRegulation(MA)
DR$FC <- (DR$distance^2)/mean(DR$distance[-1]^2)
DR$p.value <- pchisq(DR$FC, df = 1, lower.tail = FALSE)
DR$p.adj <- p.adjust(DR$p.value, method = 'fdr')
O$diffRegulation <- DR
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
drList <- DR$gene
deList <- deList[deList %in% drList]
drList <- drList[drList %in% deList]
load('../Results/Preenterocytes.RData')
MA <- O$manifoldAlignment
MA <- MA[!grepl('_MT-|_RPL|_RPS',rownames(MA), ignore.case = TRUE),]
DR <- scTenifoldNet::dRegulation(MA)
DR$FC <- (DR$distance^2)/mean(DR$distance[-1]^2)
DR$p.value <- pchisq(DR$FC, df = 1, lower.tail = FALSE)
DR$p.adj <- p.adjust(DR$p.value, method = 'fdr')
O$diffRegulation <- DR
library(fgsea)
load('../Results/Preenterocytes.RData')
MA <- O$manifoldAlignment
MA <- MA[!grepl('_MT-|_RPL|_RPS',rownames(MA), ignore.case = TRUE),]
DR <- scTenifoldNet::dRegulation(MA)
install.packages('clustermole')
library(clustermole)
install.packages('clustermole', dependencies = TRUE)
library(clustermole)
BiocManager::install('GSVA')
library(clustermole)
clustermole_markers()
M <- clustermole_markers()
View(M)
load('../Results/Preenterocytes.RData')
MA <- O$manifoldAlignment
MA <- MA[!grepl('_MT-|_RPL|_RPS',rownames(MA), ignore.case = TRUE),]
DR <- scTenifoldNet::dRegulation(MA)
#DR <- O$diffRegulation
DR$FC <- (DR$distance^2)/mean(DR$distance[-1]^2)
DR$p.value <- pchisq(DR$FC, df = 1, lower.tail = FALSE)
DR$p.adj <- p.adjust(DR$p.value, method = 'fdr')
O$diffRegulation <- DR
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
drZ <- DR$Z
MA <- O$manifoldAlignment
MA <- MA[!grepl('_MT-|_RPL|_RPS',rownames(MA), ignore.case = TRUE),]
DR <- scTenifoldNet::dRegulation(MA)
#DR <- O$diffRegulation
DR$FC <- (DR$distance^2)/mean(DR$distance[-1]^2)
DR$p.value <- pchisq(DR$FC, df = 1, lower.tail = FALSE)
DR$p.adj <- p.adjust(DR$p.value, method = 'fdr')
O$diffRegulation <- DR
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
# drZ <- DR$Z
# names(drZ) <- toupper(DR$gene)
# CT <- read.table('PanglaoDB_markers_27_Mar_2020.tsv.gz', sep = '\t', header = TRUE)
# CT <- CT[CT$organ %in% 'GI tract',]
CT <- clustermole::clustermole_markers()
CT$species %in% 'Mouse'
CT[CT$species %in% 'Mouse',]
CT <- CT[CT$species %in% 'Mouse',]
View(CT)
grepl('Intest', CT$organ, ignore.case = TRUE)
CT[grepl('Intest', CT$organ, ignore.case = TRUE),]
CT <- CT[grepl('Intest', CT$organ, ignore.case = TRUE),]
CT$celltype
lapply(CT$celltype, function(X){
lapply(CT$celltype, function(X){
unique(CT$gene[CT$celltype %in% X])
})
lapply(CT$celltype, function(X){
unique(CT$gene[CT$celltype %in% X])
})
lapply(CT$celltype, function(X){
unique(CT$gene[CT$celltype %in% X])
})
ctNames <- unique(CT$celltype)
lapply(ctNames, function(X){
unique(CT$gene[CT$celltype %in% X])
})
CT <- lapply(ctNames, function(X){
unique(CT$gene[CT$celltype %in% X])
})
names(CT)
names(CT) <- ctNames
# CM <- gmtPathways('../Data/CannonicalMarkers.txt')
# CM <- lapply(CM, toupper)
E <- fgseaMultilevel(CT, drZ)
View(E)
MA <- O$manifoldAlignment
MA <- MA[!grepl('_MT-|_RPL|_RPS',rownames(MA), ignore.case = TRUE),]
DR <- scTenifoldNet::dRegulation(MA)
#DR <- O$diffRegulation
DR$FC <- (DR$distance^2)/mean(DR$distance[-1]^2)
DR$p.value <- pchisq(DR$FC, df = 1, lower.tail = FALSE)
DR$p.adj <- p.adjust(DR$p.value, method = 'fdr')
O$diffRegulation <- DR
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
# drZ <- DR$Z
# names(drZ) <- toupper(DR$gene)
# CT <- read.table('PanglaoDB_markers_27_Mar_2020.tsv.gz', sep = '\t', header = TRUE)
# CT <- CT[CT$organ %in% 'GI tract',]
CT <- clustermole::clustermole_markers()
CT <- CT[CT$species %in% 'Mouse',]
CT <- CT[grepl('Intest', CT$organ, ignore.case = TRUE),]
ctNames <- unique(CT$celltype)
CT <- lapply(ctNames, function(X){
unique(CT$gene[CT$celltype %in% X])
})
names(CT) <- ctNames
load('../Results/Preenterocytes.RData')
MA <- O$manifoldAlignment
MA <- MA[!grepl('_MT-|_RPL|_RPS',rownames(MA), ignore.case = TRUE),]
DR <- scTenifoldNet::dRegulation(MA)
#DR <- O$diffRegulation
DR$FC <- (DR$distance^2)/mean(DR$distance[-1]^2)
DR$p.value <- pchisq(DR$FC, df = 1, lower.tail = FALSE)
DR$p.adj <- p.adjust(DR$p.value, method = 'fdr')
O$diffRegulation <- DR
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
# drZ <- DR$Z
# names(drZ) <- toupper(DR$gene)
# CT <- read.table('PanglaoDB_markers_27_Mar_2020.tsv.gz', sep = '\t', header = TRUE)
# CT <- CT[CT$organ %in% 'GI tract',]
CT <- clustermole::clustermole_markers()
CT <- CT[CT$species %in% 'Mouse',]
CT <- CT[grepl('Intest', CT$organ, ignore.case = TRUE),]
ctNames <- unique(CT$celltype)
CT <- lapply(ctNames, function(X){
unique(CT$gene[CT$celltype %in% X])
})
names(CT) <- ctNames
# CM <- gmtPathways('../Data/CannonicalMarkers.txt')
# CM <- lapply(CM, toupper)
E <- fgseaMultilevel(CT, drZ)
plotEnrichment(CT$Enterocyte, drZ)
View(DR)
View(E)
plotEnrichment(CT$`Goblet cell`, drZ)
plotEnrichment(CT$`Paneth cell`, drZ)
plotEnrichment(CT$`Transit amplifying (TA) cell`, drZ)
plotEnrichment(CT$Enterocyte, drZ)
setwd("~/scTenifoldKnk/inst/manuscript/AHR/Code")
library(Matrix)
library(Seurat)
library(harmony)
WT <- readMM('../Data/Preenterocytes_WT.mtx')
rownames(WT) <- readLines('../Data/Preenterocytes_WT_genes.txt')
colnames(WT) <- readLines('../Data/Preenterocytes_WT_barcodes.txt')
WT <- WT[!grepl('^MT-|^RPL|^RPS',rownames(WT), ignore.case = TRUE),]
KO <- readMM('../Data/Preenterocytes_KO.mtx')
rownames(KO) <- readLines('../Data/Preenterocytes_KO_genes.txt')
colnames(KO) <- readLines('../Data/Preenterocytes_KO_barcodes.txt')
KO <- KO[!grepl('^MT-|^RPL|^RPS',rownames(KO), ignore.case = TRUE),]
WT <- CreateSeuratObject(WT, project = 'WT')
KO <- CreateSeuratObject(KO, project = 'KO')
ALL <- merge(WT,KO)
ALL <- NormalizeData(ALL)
ALL <- ScaleData(ALL)
ALL <- FindVariableFeatures(ALL)
ALL <- RunPCA(ALL)
ALL <- RunHarmony(ALL, group.by.vars = 'orig.ident')
ALL <- RunTSNE(ALL, reduction = 'harmony')
ALL <- RunUMAP(ALL, reduction = 'harmony', dims = 1:50)
UMAPPlot(ALL)
DE <- FindMarkers(ALL, ident.1 = 'KO', ident.2 = 'WT', test.use = 'MAST', logfc.threshold = 0)
DE <- DE[order(abs(DE$avg_logFC), decreasing = TRUE),]
deList <- rownames(DE)
deZ <- abs(DE$avg_logFC)
names(deZ) <- toupper(rownames(DE))
deZ
# CM <- gmtPathways('../Data/CannonicalMarkers.txt')
# CM <- lapply(CM, toupper)
E <- fgseaMultilevel(CT, deZ)
View(E)
plotEnrichment(CT$Enterocyte, deZ)
DE <- FindMarkers(ALL, ident.1 = 'KO', ident.2 = 'WT', test.use = 'MAST', logfc.threshold = 0, min.pct = 0.05)
DE <- DE[order(abs(DE$avg_logFC), decreasing = TRUE),]
deList <- rownames(DE)
deZ <- abs(DE$avg_logFC)
names(deZ) <- toupper(rownames(DE))
# CM <- gmtPathways('../Data/CannonicalMarkers.txt')
# CM <- lapply(CM, toupper)
E <- fgseaMultilevel(CT, deZ)
plotEnrichment(CT$Enterocyte, deZ)
View(DE)
# CM <- gmtPathways('../Data/CannonicalMarkers.txt')
# CM <- lapply(CM, toupper)
library(ggplot2)
E <- fgseaMultilevel(CT, deZ)
plotEnrichment(CT$Enterocyte, deZ)
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score')
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'Enterocytes')
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'Enterocytes', subtitle = paste0('FDR = ', ))
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'Enterocytes', subtitle = paste0('FDR = ' ))
E$pathway == 'Enterocyte'
E$padj[E$pathway == 'Enterocyte']
formatC(E$padj[E$pathway == 'Enterocyte'], 2)
formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')))
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'MAST - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')))
E <- fgseaMultilevel(CT, drZ)
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'MAST - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')))
plotEnrichment(CT$Enterocyte, drZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'MAST - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')))
DE <- FindMarkers(ALL, ident.1 = 'KO', ident.2 = 'WT', test.use = 'MAST', logfc.threshold = 0)
DE <- DE[order(abs(DE$avg_logFC), decreasing = TRUE),]
deList <- rownames(DE)
deZ <- abs(DE$avg_logFC)
names(deZ) <- toupper(rownames(DE))
# CM <- gmtPathways('../Data/CannonicalMarkers.txt')
# CM <- lapply(CM, toupper)
library(ggplot2)
E <- fgseaMultilevel(CT, deZ)
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'MAST - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')))
drZ > 0
drZ2 <- drZ[drZ > 0]
E <- fgseaMultilevel(CT, drZ2)
plotEnrichment(CT$Enterocyte, drZ2) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'scTenifoldKnk - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')))
E <- fgseaMultilevel(CT, drZ)
plotEnrichment(CT$Enterocyte, drZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'scTenifoldKnk - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e')))
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'MAST - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + theme_bw() + theme(plot.title = element_text(size=20))
plotEnrichment(CT$Enterocyte, drZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'scTenifoldKnk - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + + theme_bw() + theme(plot.title = element_text(size=20))
plotEnrichment(CT$Enterocyte, drZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'scTenifoldKnk - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + theme_bw() + theme(plot.title = element_text(size=20))
png('DE_gseaMarkers.png', width = 1000, height = 1000, res = 300)
E <- fgseaMultilevel(CT, deZ)
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'MAST - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + theme_bw() + theme(plot.title = element_text(size=20))
dev.off()
png('DR_gseaMarkers.png', width = 1000, height = 1000, res = 300)
E <- fgseaMultilevel(CT, drZ)
plotEnrichment(CT$Enterocyte, drZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'scTenifoldKnk - Enterocytes', subtitle = paste0('FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + theme_bw() + theme(plot.title = element_text(size=20))
dev.off()
png('DR_gseaMarkers.png', width = 1000, height = 1000, res = 300)
E <- fgseaMultilevel(CT, drZ)
plotEnrichment(CT$Enterocyte, drZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'Enterocytes', subtitle = paste0('scTenifoldKnk FDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + theme_bw() + theme(plot.title = element_text(size=20))
dev.off()
png('DR_gseaMarkers.png', width = 1000, height = 1000, res = 300)
E <- fgseaMultilevel(CT, drZ)
plotEnrichment(CT$Enterocyte, drZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'Enterocytes', subtitle = paste0('scTenifoldKnk\nFDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + theme_bw() + theme(plot.title = element_text(size=20))
dev.off()
png('DE_gseaMarkers.png', width = 1000, height = 1000, res = 300)
E <- fgseaMultilevel(CT, deZ)
plotEnrichment(CT$Enterocyte, deZ) + xlab('Gene rank') + ylab('Enrichment Score') + labs(title = 'Enterocytes', subtitle = paste0('MAST\nFDR = ', formatC(E$padj[E$pathway == 'Enterocyte'], 2, format = 'e'))) + theme_bw() + theme(plot.title = element_text(size=20))
dev.off()
library(Matrix)
library(Seurat)
library(harmony)
library(ggplot2)
library(ggrepel)
load('../Results/knk_PreE.RData')
DR <- O$diffRegulation
WT <- readMM('../Data/Preenterocytes_WT.mtx')
rownames(WT) <- readLines('../Data/Preenterocytes_WT_genes.txt')
colnames(WT) <- readLines('../Data/Preenterocytes_WT_barcodes.txt')
WT <- WT[!grepl('^MT-|^RPL|^RPS',rownames(WT), ignore.case = TRUE),]
KO <- readMM('../Data/Preenterocytes_KO.mtx')
rownames(KO) <- readLines('../Data/Preenterocytes_KO_genes.txt')
colnames(KO) <- readLines('../Data/Preenterocytes_KO_barcodes.txt')
KO <- KO[!grepl('^MT-|^RPL|^RPS',rownames(KO), ignore.case = TRUE),]
WT <- CreateSeuratObject(WT, project = 'WT')
KO <- CreateSeuratObject(KO, project = 'KO')
ALL <- merge(WT,KO)
ALL <- NormalizeData(ALL)
ALL <- ScaleData(ALL)
ALL <- FindVariableFeatures(ALL)
ALL <- RunPCA(ALL)
ALL <- RunHarmony(ALL, group.by.vars = 'orig.ident')
ALL <- RunTSNE(ALL, reduction = 'harmony')
ALL <- RunUMAP(ALL, reduction = 'harmony', dims = 1:50)
UMAPPlot(ALL)
DE <- FindMarkers(ALL, ident.1 = 'KO', ident.2 = 'WT', test.use = 'MAST', logfc.threshold = 0)
DE <- DE[order(abs(DE$avg_logFC), decreasing = TRUE),]
deList <- rownames(DE)
deZ <- abs(DE$avg_logFC)
names(deZ) <- toupper(rownames(DE))
dF <- data.frame(FC=DE$avg_logFC, P=-log10(DE$p_val), G = rownames(DE))
dF <- as.data.frame.array(dF)
dF$O <- seq_len(nrow(dF))
dF <- dF[order(abs(dF$FC)),]
dF$O[!is.na(dF$G)] <- 1e6
dF <- dF[order(dF$O, decreasing = FALSE),]
dF$COL <- densCols(dF[,1:2])
dF$COL[dF$G %in% DR$gene[DR$p.adj < 0.05]] <- 'red'
dF$G[!dF$G %in% DR$gene[DR$p.adj < 0.05]] <- NA
gT <- ifelse(is.na(dF$G),0.2,1)
BG <- rownames(DE)[DE$p_val_adj < 0.05 & abs(DE$avg_logFC) > 0.1]
BG <- intersect(dF$G, BG)
FF <- ifelse(dF$G %in% BG, 2, 1)
png('VLN2.png', width = 1500, height = 1500, res=300)
ggplot(dF, aes(FC, P, label = G)) + geom_point(color = dF$COL, alpha = gT) + xlim(c(-0.55,0.55)) + theme_bw() + xlab(log[2]~'Fold-Change') + ylab(-log[10]~'P-value') + geom_text_repel(box.padding = 0.15, segment.size = 0.05, aes(fontface= FF))
dev.off()
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
drList <- DR$gene
deList <- deList[deList %in% drList]
drList <- drList[drList %in% deList]
# CLA <- compareList(deList,drList,B = 100, label = 'MAST (abs FC) vs\nscTenifoldKnk')
# png('cl1_Ahr.png', width = 1200, height = 1200, res = 300)
# CLA
# dev.off()
# library(OrderedList)
# png('DE_DR2.png', width = 2000, height = 1000, res = 300)
# par(mar=c(3,3,1,1), mgp=c(1.5,0.5,0))
# plot(compareLists(deList,drList, alphas = 0.005))
# dev.off()
library(fgsea)
KEGG <- gmtPathways('https://amp.pharm.mssm.edu/Enrichr/geneSetLibrary?mode=text&libraryName=KEGG_2019_Mouse')
REACTOME <- gmtPathways('https://amp.pharm.mssm.edu/Enrichr/geneSetLibrary?mode=text&libraryName=Reactome_2016')
drE <- fgsea(REACTOME, drZ, 1e6)
deE <- fgsea(REACTOME, deZ, 1e6)
library(UpSetR)
png('fgsea2.png', width = 600, height = 600, res = 300)
upset(fromList(list(Simulation=drE$pathway[drE$padj < 0.05 & drE$NES > 0],Real=deE$pathway[deE$padj < 0.05 & deE$NES > 0])))
dev.off()
library(Matrix)
library(Seurat)
library(harmony)
library(ggplot2)
library(ggrepel)
load('../Results/KNKF.RData')
DR <- O$diffRegulation
WT <- readMM('../Data/Preenterocytes_WT.mtx')
rownames(WT) <- readLines('../Data/Preenterocytes_WT_genes.txt')
colnames(WT) <- readLines('../Data/Preenterocytes_WT_barcodes.txt')
WT <- WT[!grepl('^MT-|^RPL|^RPS',rownames(WT), ignore.case = TRUE),]
KO <- readMM('../Data/Preenterocytes_KO.mtx')
rownames(KO) <- readLines('../Data/Preenterocytes_KO_genes.txt')
colnames(KO) <- readLines('../Data/Preenterocytes_KO_barcodes.txt')
KO <- KO[!grepl('^MT-|^RPL|^RPS',rownames(KO), ignore.case = TRUE),]
WT <- CreateSeuratObject(WT, project = 'WT')
KO <- CreateSeuratObject(KO, project = 'KO')
ALL <- merge(WT,KO)
ALL <- NormalizeData(ALL)
ALL <- ScaleData(ALL)
ALL <- FindVariableFeatures(ALL)
ALL <- RunPCA(ALL)
ALL <- RunHarmony(ALL, group.by.vars = 'orig.ident')
ALL <- RunTSNE(ALL, reduction = 'harmony')
ALL <- RunUMAP(ALL, reduction = 'harmony', dims = 1:50)
UMAPPlot(ALL)
DE <- FindMarkers(ALL, ident.1 = 'KO', ident.2 = 'WT', test.use = 'MAST', logfc.threshold = 0)
DE <- DE[order(abs(DE$avg_logFC), decreasing = TRUE),]
deList <- rownames(DE)
deZ <- abs(DE$avg_logFC)
names(deZ) <- toupper(rownames(DE))
dF <- data.frame(FC=DE$avg_logFC, P=-log10(DE$p_val), G = rownames(DE))
dF <- as.data.frame.array(dF)
dF$O <- seq_len(nrow(dF))
dF <- dF[order(abs(dF$FC)),]
dF$O[!is.na(dF$G)] <- 1e6
dF <- dF[order(dF$O, decreasing = FALSE),]
dF$COL <- densCols(dF[,1:2])
dF$COL[dF$G %in% DR$gene[DR$p.adj < 0.05]] <- 'red'
dF$G[!dF$G %in% DR$gene[DR$p.adj < 0.05]] <- NA
gT <- ifelse(is.na(dF$G),0.2,1)
BG <- rownames(DE)[DE$p_val_adj < 0.05 & abs(DE$avg_logFC) > 0.1]
BG <- intersect(dF$G, BG)
FF <- ifelse(dF$G %in% BG, 2, 1)
png('VLN3.png', width = 1500, height = 1500, res=300)
ggplot(dF, aes(FC, P, label = G)) + geom_point(color = dF$COL, alpha = gT) + xlim(c(-0.55,0.55)) + theme_bw() + xlab(log[2]~'Fold-Change') + ylab(-log[10]~'P-value') + geom_text_repel(box.padding = 0.15, segment.size = 0.05, aes(fontface= FF))
dev.off()
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
drList <- DR$gene
deList <- deList[deList %in% drList]
drList <- drList[drList %in% deList]
# CLA <- compareList(deList,drList,B = 100, label = 'MAST (abs FC) vs\nscTenifoldKnk')
# png('cl1_Ahr.png', width = 1200, height = 1200, res = 300)
# CLA
# dev.off()
# library(OrderedList)
# png('DE_DR2.png', width = 2000, height = 1000, res = 300)
# par(mar=c(3,3,1,1), mgp=c(1.5,0.5,0))
# plot(compareLists(deList,drList, alphas = 0.005))
# dev.off()
library(fgsea)
KEGG <- gmtPathways('https://amp.pharm.mssm.edu/Enrichr/geneSetLibrary?mode=text&libraryName=KEGG_2019_Mouse')
REACTOME <- gmtPathways('https://amp.pharm.mssm.edu/Enrichr/geneSetLibrary?mode=text&libraryName=Reactome_2016')
drE <- fgsea(REACTOME, drZ, 1e6)
deE <- fgsea(REACTOME, deZ, 1e6)
library(UpSetR)
png('fgsea3.png', width = 600, height = 600, res = 300)
upset(fromList(list(Simulation=drE$pathway[drE$padj < 0.05 & drE$NES > 0],Real=deE$pathway[deE$padj < 0.05 & deE$NES > 0])))
dev.off()
deZ
plot(deZ, drZ)
View(drE)
View(deE)
drE$pathway[drE$padj < 0.05 & drE$NES > 0]
View(drE)
deE$pathway[deE$padj < 0.05 & deE$NES > 0]
plot(drZ)
DR$gene[DR$p.adj < 0.05]
load('../Results/KNKF.RData')
DR <- O$diffRegulation
DR$gene[DR$p.adj < 0.05]
O$manifoldAlignment
grepl('_Rpl|_Rps',O$manifoldAlignment)
O$manifoldAlignment[!grepl('_Rpl|_Rps',O$manifoldAlignment),]
O$manifoldAlignment[!grepl('_Rpl|_Rps',rownames(O$manifoldAlignment)),]
O$manifoldAlignment <- O$manifoldAlignment[!grepl('_Rpl|_Rps',rownames(O$manifoldAlignment)),]
DR <- scTenifoldKnk:::dRegulation(O$manifoldAlignment)
DR <- scTenifoldKnk:::dRegulation(O$manifoldAlignment, 'Ahr')
View(DR)
DR$gene[DR$p.adj < 0.05]
DR$gene[DR$p.adj < 0.05]
writeLines(DR$gene[DR$p.adj < 0.05])
png('KO3.png', width = 3500, height = 3500, res = 300)
plotKO(O, 'Ahr', nCategories = 10)
dev.off()
source('https://raw.githubusercontent.com/dosorio/utilities/master/singleCell/plotKO.R')
source('https://raw.githubusercontent.com/dosorio/utilities/master/singleCell/plotDR.R')
png('KO3.png', width = 3500, height = 3500, res = 300)
plotKO(O, 'Ahr', nCategories = 10)
dev.off()
O$diffRegulation <- DR
png('KO3.png', width = 3500, height = 3500, res = 300)
plotKO(O, 'Ahr', nCategories = 10)
dev.off()
drZ <- DR$Z
names(drZ) <- toupper(DR$gene)
drE <- fgsea(REACTOME, drZ, 1e6)
library(UpSetR)
png('fgsea3.png', width = 600, height = 600, res = 300)
upset(fromList(list(Simulation=drE$pathway[drE$padj < 0.05 & drE$NES > 0],Real=deE$pathway[deE$padj < 0.05 & deE$NES > 0])))
dev.off()
